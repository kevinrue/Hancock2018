---
title: "Applying Gene Signatures to the Seurat PBMC 3k Tutorial"
author: "Kevin Rue-Albrecht"
date: "`r BiocStyle::doc_date()`"
output:
  html_document:
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_chunk$set(cache=TRUE)
suppressPackageStartupMessages({
    library(SingleCellExperiment)
    library(GSEABase)
    library(hancock)
    library(S4Vectors)
    library(knitr)
    library(ComplexHeatmap)
    library(ggplot2)
    library(cowplot)
})
```

# Example data set

First, load the preprocessed `r Biocpkg("SingleCellExperiment")` object of [10X Genomics](www.10xgenomics.com) 2,700 peripheral blood mononuclear cells (PBMC)

```{r, }
sce <- readRDS("pbmc3k_tutorial.sce.rds")
sce
```

# Gene signatures

Declare the predefined gene signatures used in the [Seurat - Guided Clustering Tutorial](https://satijalab.org/seurat/pbmc3k_tutorial_1_4.html)

```{r}
gsc <- GeneSetCollection(list(
    GeneSet(setName="CD4 T cells", c("IL7R")),
    GeneSet(setName="CD14+ Monocytes", c("CD14", "LYZ")),
    GeneSet(setName="B cells", c("MS4A1")),
    GeneSet(setName="CD8 T cells", c("CD8A")),
    GeneSet(setName="FCGR3A+ Monocytes", c("FCGR3A", "MS4A7")),
    GeneSet(setName="NK cells", c("GNLY", "NKG7")),
    GeneSet(setName="Dendritic Cells", c("FCER1A", "CST3")),
    GeneSet(setName="Megakaryocytes", c("PPBP"))
))
gsc
```

# Applying signatures to a data set

## The `predict` method

The `r Biocpkg("GSEABase")` `GeneSetCollection` object can immediately be supplied to the `predict` S3 method, in combination with the `r Biocpkg("SummarizedExperiment")` object to annotate.

```{r}
sce <- predict(gsc, sce, method="ProportionPositive", cluster.col="ident")
```

## Prediction outputs

The updated `r Biocpkg("SummarizedExperiment")` object is returned, with a number of additional metadata.

The key output is the cell identity predicted for each cell in the object.
This information is stored in `colData(sce)[["hancock"]][["prediction"]]`, or `sce$hancock$prediction`, in short.

```{r}
table(sce$hancock$prediction)
```

With `method="ProportionPositive"`, all cells in each cluster were annotated with the predominant signature in their corresponding cluster.
As such, the cell type prediction may be tabulated against the cluster membership of each cell.

```{r}
table(sce$hancock$prediction, sce$ident)
```

This can potentially highlight multiple clusters labelled by the same predicted label as a sign of overclustering.

In addition to the final predictions, the updated `r Biocpkg("SummarizedExperiment")` object also contain some additional information tracing to the process of prediction.
That information can be found in `metadata(sce)[["hancock"]]`.

```{r}
names(metadata(sce)[["hancock"]])
```

In particular:

- `GeneSets` stores the `GeneSetCollection` object used to make the predictions
- `method` stores the name of the method used to make the predictions
- `packageVersion` stores the version of the `hancock` package used to make the predictions
- `ProportionPositiveByCluster` stores the matrix indicating the proportion of cells in each cluster that are positive for each signature (i.e., `GeneSet`) in `GeneSetCollection`
- `TopSignatureByCluster` stores a named vector that indicates the predominant signature for each cluster. It is shown below.

```{r}
metadata(sce)[["hancock"]][["TopSignatureByCluster"]]
```

# Visualizing predictions

## Heat map

It is possible to visualize the result as a heat map.
See how the diagonal (displaying the tutorial annotations) shows high proportions of cells matching the annotated signature.

```{r}
plotProportionPositive(sce, cluster_rows=FALSE, cluster_columns=FALSE)
```

We can also let signatures and clusters of cells cluster in the heat map.
Not surprisingly, the clusters annotated as "CD14+ Monocytes" and "FCGR3A+ Monocytes" show some similarity, as do the clusters annotated as "CD4 T cells" and "CD8 T cells".

```{r}
plotProportionPositive(sce)
```

## Reduced dimension

We can also display the expression of each marker on t-SNE result.

```{r, fig.height=10}
ggList <- list()
for (markerName in unique(unlist(geneIds(gsc)))) {
    ggDataFrame <- data.frame(
        reducedDim(sce, "TSNE"),
        logcounts=assay(sce, "logcounts")[markerName, ]
    )
    cellIdentity <- names(which(sapply(geneIds(gsc), function(x){markerName %in% x})))
    gg <- ggplot(ggDataFrame, aes(tSNE_1, tSNE_2, color=logcounts)) +
        geom_point(size=0.1) +
        scale_color_viridis_c() +
        labs(title=markerName, subtitle=cellIdentity, x=NULL, y=NULL) +
        theme(
            axis.text = element_blank(), axis.ticks = element_blank(),
            text = element_text(size=rel(3)), legend.text = element_text(size=rel(2)),
            legend.position = "bottom")
    ggList[[markerName]] <- gg
}
cowplot::plot_grid(plotlist = ggList)
```

# See also

- [Learning Gene Signatures from the Seurat PBMC 3k Tutorial](2-learn-signatures.html)
