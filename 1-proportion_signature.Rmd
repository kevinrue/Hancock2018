---
title: "Proportion of cells matching signatures"
author: "Kevin Rue-Albrecht"
date: "24/11/2018"
output:
  html_document:
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_chunk$set(cache=TRUE)
suppressPackageStartupMessages({
    library(SingleCellExperiment)
    library(GSEABase)
    library(Hancock)
    library(S4Vectors)
    library(knitr)
    library(ComplexHeatmap)
    library(ggplot2)
    library(cowplot)
})
```

Load the preprocessed SingleCellExperiment object of 10x PBMC 3k.

```{r, }
sce <- readRDS("pbmc3k_tutorial.sce.rds")
sce
```

Define the signatures used in the tutorial.

```{r}
gsc <- GeneSetCollection(list(
    GeneSet(setName="CD4 T cells", c("IL7R")),
    GeneSet(setName="CD14+ Monocytes", c("CD14", "LYZ")),
    GeneSet(setName="B cells", c("MS4A1")),
    GeneSet(setName="CD8 T cells", c("CD8A")),
    GeneSet(setName="FCGR3A+ Monocytes", c("FCGR3A", "MS4A7")),
    GeneSet(setName="NK cells", c("GNLY", "NKG7")),
    GeneSet(setName="Dendritic Cells", c("FCER1A", "CST3")),
    GeneSet(setName="Megakaryocytes", c("PPBP"))
))
gsc
```

The `GeneSetCollection` can immediately be supplied to a `predict` S3 method, in combination with the `SummarizedExperiment` object to annotate.

```{r}
sce <- predict(gsc, sce, method="ProportionPositive", cluster.col="ident")
```

The `SummarizedExperiment` object is returned with a number of additional metadata.

Most users will be interested in the cell identity annotated to each cell in the object.
This information is stored in `colData(sce)[["Hancock"]][["prediction"]]`, or `sce$Hancock$prediction`, in short.

```{r}
table(sce$Hancock$prediction)
```

With `method="ProportionPositive"`, all cells in each of the cluster supplied were annotated with the predominant signature in the cluster.
Here is one way to visualize the assignment of cell identities to each cluster.

```{r}
table(sce$Hancock$prediction, sce$ident)
```

In addition to the final predictions, the updated `SummarizedExperiment` object also contain some additional information tracing to the process of prediction.
That information can be found in `metadata(sce)[["Hancock"]]`.

```{r}
names(metadata(sce)[["Hancock"]])
```

In particular:

- `GeneSetCollection` stores the `GeneSetCollection` object used to make the predictions
- `method` stores the name of the method used to make the predictions
- `packageVersion` stores the version of the `Hancock` package used to make the predictions
- `ProportionPositiveByCluster` stores the matrix indicating the proportion of cells in each cluster that are positive for each signature (i.e., `GeneSet`) in `GeneSetCollection`
- `TopSignatureByCluster` stores a named vector that indicates the predominant signature for each cluster

```{r}
metadata(sce)[["Hancock"]][["TopSignatureByCluster"]]
```

Visualize the result as a heat map.
See how the diagonal (displaying the tutorial annotations) shows high proportions of cells matching the annotated signature.

```{r}
ProportionPositiveByCluster <- metadata(sce)[["Hancock"]][["ProportionPositiveByCluster"]]
sceGSC <- metadata(sce)[["Hancock"]][["GeneSetCollection"]]
colnames(ProportionPositiveByCluster) <- paste(
    colnames(ProportionPositiveByCluster),
    sprintf("(%s)", lapply(sceGSC, function(x){paste(geneIds(x), collapse=", ")})),
    sep="\n"
)
Heatmap(matrix=t(ProportionPositiveByCluster), cluster_rows=FALSE, cluster_columns=FALSE)
```

Let signatures and clusters of cells cluster in the heat map.
Unsurprisingly, the clusters annotated as "CD14+ Monocytes" and "FCGR3A+ Monocytes" show some similarity, as do the clusters annotated as "CD4 T cells" and "CD8 T cells".

```{r}
Heatmap(matrix=t(ProportionPositiveByCluster))
```

Display the expression of each marker on t-SNE result.

```{r, fig.height=10}
ggList <- list()
for (markerName in unique(unlist(geneIds(gsc)))) {
    ggDataFrame <- data.frame(
        reducedDim(sce, "TSNE"),
        logcounts=assay(sce, "logcounts")[markerName, ]
    )
    cellIdentity <- names(which(sapply(geneIds(gsc), function(x){markerName %in% x})))
    gg <- ggplot(ggDataFrame, aes(tSNE_1, tSNE_2, color=logcounts)) +
        geom_point(size=0.1) +
        scale_color_viridis_c() +
        labs(title=markerName, subtitle=cellIdentity, x=NULL, y=NULL) +
        theme(
            axis.text = element_blank(), axis.ticks = element_blank(),
            text = element_text(size=rel(3)), legend.text = element_text(size=rel(2)),
            legend.position = "bottom")
    ggList[[markerName]] <- gg
}
cowplot::plot_grid(plotlist = ggList)
```
