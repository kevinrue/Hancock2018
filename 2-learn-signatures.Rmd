---
title: "Learning Gene Signatures from the Seurat PBMC 3k Tutorial"
author: "Kevin Rue-Albrecht"
date: "19/12/2018"
output:
  html_document:
    code_folding: hide
output_dir: docs
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_chunk$set(cache=TRUE)
suppressPackageStartupMessages({
    library(SingleCellExperiment)
    library(hancock)
    library(GeneSet)
    library(ggplot2)
    library(cowplot)
    library(shiny)
})
```

# Example data set

First, we load the preprocessed SingleCellExperiment object of 10x PBMC 3k.

```{r, }
sce <- readRDS("pbmc3k_tutorial.sce.rds")
sce
```

# Learning signatures from a data set

According to the tutorial, cluster "0" comprises CD4 T cells marked by the expression of the gene _IL7R_.
When applying the _IL7R_ signature, we have shown that indeed _IL7R_ is expressed at a relatively high frequency in cluster "0" and much less frequently detected in all other clusters.

Now, let us programmatically identify the top 2 markers for each cluster by asking the question:
"Which genes are detected in the target cluster at a frequency at least 20% higher than any other cluster"?

```{r}
tgs <- learnSignatures(
    sce, method = "PositiveProportionDifference",
    cluster.col="ident", assay.type = "counts", threshold = 0, n = 2, min.diff = 0.2)
knitr::kable(tgs)
```

Note that the table above does highlight some of the markers suggested in the [Seurat tutorial](https://satijalab.org/seurat/pbmc3k_tutorial_1_4.html) (listed below).
Namely, CD14 (CD14+ Monocytes), MS4A1 (B cells), CD8A (CD8 T cells), FCER1A (Dendritic Cells), PPBP (Megakaryocytes).

```{r}
seuratTutorialMarkers <- tbl_geneset(
    "CD4 T cells"=c("IL7R"),
    "CD14+ Monocytes"=c("CD14", "LYZ"),
    "B cells"=c("MS4A1"),
    "CD8 T cells"=c("CD8A"),
    "FCGR3A+ Monocytes"=c("FCGR3A", "MS4A7"),
    "NK cells"=c("GNLY", "NKG7"),
    "Dendritic Cells"=c("FCER1A", "CST3"),
    "Megakaryocytes"=c("PPBP")
)
seuratTutorialMarkers
```

# Visualizing signatures

## Reduced dimension

Let us visualize the top 2 markers for each cluster.
The cell type identity associated with markers mentioned in the [Seurat tutorial](https://satijalab.org/seurat/pbmc3k_tutorial_1_4.html) is indicated in each panel subtitle. 

```{r, fig.height=12, fig.width=8}
ggList <- list()
for (markerName in tgs$gene) {
    ggDataFrame <- data.frame(
        reducedDim(sce, "TSNE"),
        logcounts=assay(sce, "logcounts")[markerName, ]
    )
    seuratIdentity <- as.character(subset(seuratTutorialMarkers, gene == markerName, "set", drop=TRUE))
    if (length(seuratIdentity) == 0) { seuratIdentity <- " "} # trick to make equal plot dimensions
    gg <- ggplot(ggDataFrame, aes(tSNE_1, tSNE_2, color=logcounts)) +
        geom_point(size=0.1) +
        scale_color_viridis_c() +
        labs(title=markerName, subtitle=seuratIdentity, x=NULL, y=NULL) +
        theme(
            axis.text = element_blank(), axis.ticks = element_blank(),
            title = element_text(size=rel(0.9)),
            legend.text = element_text(size=rel(0.8)), legend.title = element_text(size=rel(0.8)),
            legend.position = "bottom")
    ggList[[markerName]] <- gg
}
cowplot::plot_grid(plotlist = ggList)
```

## Interactively

It is possible to interactively set the names of each gene signature learned using an interactive _Shiny_ app.
For this purpose, we learn as many markers as possible for each cluster, and we pass both the signatures (as a `tbl_geneset` object) and the annotated `SingleCellExperiment` to the interactive app.

```{r}
tgs <- learnSignatures(
    sce, method = "PositiveProportionDifference",
    cluster.col="ident", assay.type = "counts", threshold = 0, n = Inf, min.diff = 0.2)
scePred <- predict(tgs, sce, method="ProportionPositive", cluster.col="ident")
if (interactive()){
    tgs <- runApp(shinyLabels(tgs, scePred))
}
```

Note how the returned `tgs` object contains any update you may have done to the names of the gene sets interactively within the app.

## Proportion of cells predicted for each signature

One may also visualize the proportion of cells positive for each signature in each cluster.
If you renamed any signature in the previous chunk, the `predict` method may be run again to apply the new labels to the `SingleCellExperiment` object.

```{r}
scePred <- predict(tgs, sce, method="ProportionPositive", cluster.col="ident")
plotProportionPositive(scePred, cluster_columns=FALSE, cluster_rows=FALSE)
```

# Concepts

## Scree detection plot

The learning method `"PositiveProportionDifference"` allows the trimming of candidate markers to those that are _simultaneously_ detected in a minimal proportion of samples in the target cluster.
For the purpose of defining qualitative gene signatures, it can be useful to ensure that all of the combined gene set that makes up a signature is fully detected in a minimal proportion of samples.

To illustrate this process, the code chunk below computes and displays the proportion of cells in cluster `"0"` in which the N most frequently detected markers are simultaneously detected.
The figure displays the proportion of samples with detectable expression of the most frequently detected gene, the two most frequently detected genes (simultaneously), etc.

```{r}
# Choose a cluster for this example
cluster0 <- "0"
topMarkers <- 100
# Fetch only the cells of that cluster
sce0 <- sce[, sce$ident == cluster0]
# Extract a subset of the most frequently detected genes in those cells
freq0 <- Matrix::rowSums(assay(sce0, "counts"))
order0 <- order(freq0, decreasing=TRUE)
# Test whether each marker is detected in each cell
detection0 <- makeMarkerDetectionMatrix(sce0, head(rownames(sce0)[order0], topMarkers))
# Compute the simultaneous detection rate for increasing numbers of markers
scree0 <- makeMarkerProportionScree(detection0)
# Plot
ggplot(scree0, aes(markers, proportion)) +
    geom_line() + geom_point(size=0.4) +
    scale_y_continuous(limits=c(0, 1)) + scale_x_continuous(limits=c(1, topMarkers)) +
    theme(panel.grid.major=element_line(color="grey90", size=0.5)) +
    labs(x="Number of top markers", y="Proportion positive for all markers")
```

# See also

- [Applying Gene Signatures to the Seurat PBMC 3k Tutorial](1-proportion_signature.html)
